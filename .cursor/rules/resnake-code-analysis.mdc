---
description: Regla especÃ­fica de anÃ¡lisis de cÃ³digo para ReSnake - patrones, anti-patrones y validaciones
globs: src/**/*.ts, src/**/*.js
alwaysApply: true
---

# AnÃ¡lisis de CÃ³digo - Proyecto ReSnake

## ğŸ” ANÃLISIS OBLIGATORIO ANTES DE MODIFICAR CÃ“DIGO

### Pre-AnÃ¡lisis Requerido
**ANTES de tocar cualquier lÃ­nea de cÃ³digo:**

1. **SEQUENTIAL THINKING** - Analizar con pensamientos estructurados (casos complejos)
2. **LEER COMPLETAMENTE** el archivo objetivo
3. **IDENTIFICAR** su rol en la arquitectura ECS
4. **CONSULTAR** el grafo de conocimiento MCP
5. **ADR ANALYSIS** - Validar impacto arquitectÃ³nico
6. **SUPABASE MCP** - Validar esquema y queries (si aplica a BD)
7. **ENTENDER** las relaciones con otros componentes
8. **VERIFICAR** que la modificaciÃ³n respeta SOLID

### Ejemplo de Flujo de AnÃ¡lisis
```typescript
// PASO 1: Sequential Thinking
mcp_sequential-thinking_sequentialthinking({
  thought: "Voy a modificar [archivo]. Primero debo entender su rol en ECS y las dependencias...",
  nextThoughtNeeded: true,
  thoughtNumber: 1,
  totalThoughts: 5
})

// PASO 2: Consultar Knowledge Graph
mcp_memory_aim_search_nodes({query: "nombre_del_componente"})

// PASO 3: ADR Analysis
mcp_adr-analysis_get_architectural_context({
  filePath: "src/path/to/file.ts",
  includeCompliance: true
})

// PASO 4: Supabase MCP (si aplica)
mcp_supabase_list_tables({
  project_id: "project_id",
  schemas: ["public"]
})
```

## ğŸ—ï¸ PATRONES DE ARQUITECTURA ECS

### âœ… Patrones Correctos - SIEMPRE USAR

#### Componentes (src/components/)
```typescript
// âœ… CORRECTO: Componente puro con datos
export class Position {
  constructor(public x: number, public y: number) {}
  
  equals(other: Position): boolean {
    return this.x === other.x && this.y === other.y;
  }
}
```

#### Entidades (src/entities/)
```typescript
// âœ… CORRECTO: Entidad que compone componentes
export class Snake extends BaseEntity {
  constructor(initialPosition: Position) {
    super('snake');
    this.addComponent(new Position(initialPosition.x, initialPosition.y));
    this.addComponent(new Velocity(DIRECTIONS.RIGHT.x, DIRECTIONS.RIGHT.y));
  }
}
```

#### Sistemas (src/systems/)
```typescript
// âœ… CORRECTO: Sistema que procesa entidades
export class MovementSystem implements System {
  update(deltaTime: number, entities: Entity[]): void {
    entities.forEach(entity => {
      if (entity.hasComponent(Position) && entity.hasComponent(Velocity)) {
        // Procesar movimiento
      }
    });
  }
}
```

### âŒ Anti-Patrones Prohibidos

```typescript
// âŒ PROHIBIDO: LÃ³gica en componentes
export class Position {
  move(direction: Direction): void { // âŒ Componente no debe tener lÃ³gica
    this.x += direction.x;
    this.y += direction.y;
  }
}

// âŒ PROHIBIDO: Sistema que modifica directamente propiedades
export class MovementSystem {
  update(deltaTime: number, entities: Entity[]): void {
    entities.forEach(entity => {
      entity.x += 1; // âŒ Acceso directo a propiedades
    });
  }
}

// âŒ PROHIBIDO: Herencia profunda
export class AdvancedSnake extends Snake extends Entity { // âŒ MÃºltiples herencias
}
```

## ğŸ¯ ANÃLISIS POR TIPO DE ARCHIVO

### Archivos de Componentes (src/components/)
**Validaciones obligatorias:**
- âœ… Solo contienen datos (estructuras puras)
- âœ… No tienen lÃ³gica de negocio
- âœ… MÃ©todos utilitarios simples (equals, clone)
- âœ… Inmutables cuando sea posible
- âŒ No tienen dependencias externas
- âŒ No manejan estado mutable

### Archivos de Entidades (src/entities/)
**Validaciones obligatorias:**
- âœ… Heredan de BaseEntity
- âœ… Componen componentes en constructor
- âœ… LÃ³gica especÃ­fica de la entidad Ãºnicamente
- âœ… MÃ©todos que encapsulan comportamiento especÃ­fico
- âŒ No procesan otras entidades
- âŒ No contienen lÃ³gica de sistemas

### Archivos de Sistemas (src/systems/)
**Validaciones obligatorias:**
- âœ… Implementan interface System
- âœ… Procesan entidades con componentes especÃ­ficos
- âœ… Una sola responsabilidad por sistema
- âœ… MÃ©todo update() con deltaTime
- âŒ No manejan estado persistente
- âŒ No dependen de otros sistemas directamente

### Archivos de Servicios (src/services/)
**Validaciones obligatorias:**
- âœ… PatrÃ³n singleton cuando sea apropiado
- âœ… Responsabilidad Ãºnica y bien definida
- âœ… InyecciÃ³n de dependencias
- âœ… Manejo de errores apropiado
- âŒ No contienen lÃ³gica de renderizado
- âŒ No acceden directamente al DOM

## ğŸ”§ ANÃLISIS DE INTEGRACIÃ“N

### Verificaciones de IntegraciÃ³n
**Antes de modificar cualquier archivo, verificar:**

1. **Dependencias Importadas**
   ```typescript
   // âœ… CORRECTO: Imports especÃ­ficos
   import { Position } from '@/components/Position';
   import { DIRECTIONS } from '@/config/constants';
   
   // âŒ INCORRECTO: Imports genÃ©ricos
   import * from '@/components';
   ```

2. **Uso de ConfiguraciÃ³n Centralizada**
   ```typescript
   // âœ… CORRECTO: Usar constantes centralizadas
   import { GAME_CONFIG, DIRECTIONS } from '@/config/constants';
   
   // âŒ INCORRECTO: Valores hardcodeados
   const BOARD_SIZE = 20; // âŒ Debe estar en constants.ts
   ```

3. **Tipado Estricto**
   ```typescript
   // âœ… CORRECTO: Tipos explÃ­citos
   function moveSnake(snake: Snake, direction: Direction): void {
   
   // âŒ INCORRECTO: Tipos implÃ­citos
   function moveSnake(snake, direction) { // âŒ Sin tipos
   ```

## ğŸ® ANÃLISIS ESPECÃFICO DEL JUEGO

### Funcionalidades CrÃ­ticas a Preservar

#### Sistema de Pausa
```typescript
// âœ… CORRECTO: Pausa completa del game loop
private togglePause(): void {
  if (this.isPaused) {
    this.engine?.resume();
    this.inputSystem?.enable();
  } else {
    this.engine?.pause();
    this.inputSystem?.disable();
  }
}
```

#### Wrap-around del Movimiento
```typescript
// âœ… CORRECTO: Movimiento con wrap-around
private wrapPosition(position: Position): Position {
  return new Position(
    (position.x + GAME_CONFIG.BOARD_SIZE) % GAME_CONFIG.BOARD_SIZE,
    (position.y + GAME_CONFIG.BOARD_SIZE) % GAME_CONFIG.BOARD_SIZE
  );
}
```

#### Easter Egg RomÃ¡ntico
```typescript
// âœ… CORRECTO: ActivaciÃ³n condicional del Easter Egg
if (score === ROMANTIC_EASTER_EGG_CONFIG.SPECIAL_SCORE && 
    romanticEasterEgg.isEasterEggActive() && 
    this.currentMode === 'classic') {
  renderSystem.startHeartRain();
}
```

## ğŸ“± ANÃLISIS DE RESPONSIVIDAD

### Controles MÃ³viles - SIEMPRE PRESERVAR
```typescript
// âœ… CORRECTO: Soporte mÃ³vil y desktop
private setupInputHandlers(): void {
  // Desktop
  document.addEventListener('keydown', this.handleKeyDown);
  
  // MÃ³vil
  canvas.addEventListener('touchstart', this.handleTouchStart);
  canvas.addEventListener('touchmove', this.handleTouchMove);
}
```

### Layout Responsivo
```css
/* âœ… CORRECTO: Media queries para mÃ³vil */
@media (max-width: 768px) {
  .game-container {
    flex-direction: column;
  }
  
  .controls-mobile {
    display: flex;
  }
}
```

## ğŸ” ANÃLISIS DE RENDIMIENTO

### Optimizaciones CrÃ­ticas a Mantener

#### RequestAnimationFrame
```typescript
// âœ… CORRECTO: Game loop optimizado
private loop = (timestamp: number): void => {
  if (this.state !== GameState.PLAYING) return;
  
  const deltaTime = timestamp - this.lastTimestamp;
  this.lastTimestamp = timestamp;
  
  this.update(deltaTime);
  this.animationFrameId = requestAnimationFrame(this.loop);
};
```

#### Canvas Rendering
```typescript
// âœ… CORRECTO: Renderizado eficiente
private render(): void {
  this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
  
  // Renderizar solo entidades visibles
  this.entities.forEach(entity => {
    if (entity.hasComponent(Renderable)) {
      this.renderEntity(entity);
    }
  });
}
```

## ğŸ§ª ANÃLISIS DE TESTING

### Estructura de Tests Requerida
```typescript
// âœ… CORRECTO: Tests para componentes
describe('Position', () => {
  it('should compare positions correctly', () => {
    const pos1 = new Position(10, 20);
    const pos2 = new Position(10, 20);
    expect(pos1.equals(pos2)).toBe(true);
  });
});

// âœ… CORRECTO: Tests para sistemas
describe('MovementSystem', () => {
  it('should move entities with velocity', () => {
    const system = new MovementSystem();
    const entity = createTestEntity();
    
    system.update(16, [entity]);
    
    expect(entity.getComponent(Position).x).toBe(11);
  });
});
```

## ğŸ“Š MÃ‰TRICAS DE CÃ“DIGO

### Indicadores de Calidad
- **Complejidad CiclomÃ¡tica**: < 10 por mÃ©todo
- **LÃ­neas por funciÃ³n**: < 50 lÃ­neas
- **LÃ­neas por archivo**: < 300 lÃ­neas
- **Cobertura de tipos**: 100%
- **Dependencias**: MÃ­nimas y explÃ­citas

### AnÃ¡lisis de Complejidad
```typescript
// âœ… CORRECTO: MÃ©todo simple y enfocado
public grow(): void {
  this.shouldGrow = true;
}

// âŒ INCORRECTO: MÃ©todo complejo con mÃºltiples responsabilidades
public complexMethod(): void {
  // 100+ lÃ­neas de cÃ³digo mezclando lÃ³gica
  // MÃºltiples responsabilidades
  // Dificil de testear
}
```

## ğŸ”„ ANÃLISIS DE REFACTORING

### SeÃ±ales de Necesidad de Refactoring
1. **MÃ©todos > 50 lÃ­neas**
2. **Clases > 300 lÃ­neas**
3. **DuplicaciÃ³n de cÃ³digo**
4. **MÃºltiples niveles de anidaciÃ³n**
5. **Dependencias circulares**

### Patrones de Refactoring Aprobados
```typescript
// âœ… CORRECTO: Extraer mÃ©todo
private handleGameOver(): void {
  this.stopGame();
  this.showGameOverScreen();
  this.updateLeaderboard();
}

// âœ… CORRECTO: Usar constantes
private getGameOverMessage(): string {
  return this.i18n.t('game.gameOver');
}
```

## âš ï¸ CHECKLIST OBLIGATORIO EXPANDIDO

### Antes de Modificar
- [ ] âœ… **Sequential Thinking**: AnalicÃ© con pensamientos estructurados
- [ ] âœ… **Knowledge Graph**: ConsultÃ© el grafo de conocimiento
- [ ] âœ… **ADR Analysis**: ValidÃ© impacto arquitectÃ³nico
- [ ] âœ… **Supabase MCP**: ValidÃ© esquema/queries (si aplica)
- [ ] âœ… **Lectura**: LeÃ­ el archivo completamente
- [ ] âœ… **ECS**: IdentifiquÃ© su rol en la arquitectura

### Durante ModificaciÃ³n
- [ ] âœ… CÃ³digo sigue arquitectura ECS
- [ ] âœ… Tipado estricto de TypeScript
- [ ] âœ… No hay valores hardcodeados
- [ ] âœ… Responsividad mÃ³vil preservada
- [ ] âœ… Principios SOLID aplicados
- [ ] âœ… Sin dependencias circulares
- [ ] âœ… Manejo de errores apropiado
- [ ] âœ… DocumentaciÃ³n JSDoc actualizada

### Antes de Commit
- [ ] âœ… **Knowledge Graph**: ActualicÃ© observaciones
- [ ] âœ… **ADR Analysis**: EjecutÃ© validaciÃ³n MCP
- [ ] âœ… **Supabase MCP**: ValidÃ© impacto en BD (si aplica)
- [ ] âœ… **Sequential Thinking**: ReflexionÃ© sobre resultados

### AnÃ¡lisis de Impacto
- [ ] âœ… Cambios no afectan otros sistemas
- [ ] âœ… Performance mantenido
- [ ] âœ… Easter Egg funcional
- [ ] âœ… Leaderboard operativo
- [ ] âœ… Controles mÃ³viles funcionando
- [ ] âœ… Build size no incrementado significativamente

---

**ğŸ¯ RECORDATORIO CRÃTICO**: 

1. **Sequential Thinking PRIMERO** para anÃ¡lisis complejo
2. **Knowledge Graph SIEMPRE** antes de modificar
3. **ADR Analysis** para cambios arquitectÃ³nicos
4. **Supabase MCP** para cambios de base de datos

**Este anÃ¡lisis debe ejecutarse ANTES de cualquier modificaciÃ³n de cÃ³digo. El proyecto ReSnake tiene una arquitectura ECS bien establecida que debe ser preservada y respetada en todo momento.**

**NO MODIFICAR SIN COMPLETAR EL CHECKLIST EXPANDIDO.**

